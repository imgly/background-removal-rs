# Multi-Model Support Implementation Plan (Compile-Time Only)

## Objective
Extend the background removal system to support multiple models beyond ISNet by implementing model-specific configuration through model.json files and reorganizing models into subfolders. All model selection and configuration will be determined at compile-time through Cargo features.

## Current System Analysis

### Hardcoded ISNet Dependencies
- **Input/output dimensions**: 1024x1024 hardcoded in image_processing.rs
- **Normalization parameters**: Mean=[128,128,128], Std=[256,256,256] hardcoded
- **Model metadata**: Hardcoded in models.rs for ISNet-FP16/FP32
- **Directory structure**: Flat models/ directory with isnet_fp16.onnx and isnet_fp32.onnx

### Current Architecture
- `ModelManager` with single `EmbeddedModelProvider`
- Feature-based model selection (fp16-model/fp32-model)
- Backend-agnostic `InferenceBackend` trait
- Single preprocessing/postprocessing pipeline in `ImageProcessor`
- Compile-time model embedding via include_bytes!

## Proposed Directory Structure

```
models/
â”œâ”€â”€ isnet/
â”‚   â”œâ”€â”€ model.json
â”‚   â”œâ”€â”€ isnet_fp16.onnx
â”‚   â””â”€â”€ isnet_fp32.onnx
â”œâ”€â”€ u2net/
â”‚   â”œâ”€â”€ model.json
â”‚   â”œâ”€â”€ u2net_fp16.onnx
â”‚   â””â”€â”€ u2net_fp32.onnx
â””â”€â”€ rembg/
    â”œâ”€â”€ model.json
    â”œâ”€â”€ rembg_fp16.onnx
    â””â”€â”€ rembg_fp32.onnx
```

## model.json Schema

```json
{
  "name": "ISNet",
  "version": "1.0.0",
  "description": "Intermediate Supervision Network for salient object detection",
  "author": "Xuebin Qin et al.",
  "license": "Apache-2.0",
  "variants": {
    "fp16": {
      "file": "isnet_fp16.onnx",
      "precision": "fp16",
      "size_bytes": 88080384,
      "input_shape": [1, 3, 1024, 1024],
      "output_shape": [1, 1, 1024, 1024]
    },
    "fp32": {
      "file": "isnet_fp32.onnx", 
      "precision": "fp32",
      "size_bytes": 176160768,
      "input_shape": [1, 3, 1024, 1024],
      "output_shape": [1, 1, 1024, 1024]
    }
  },
  "preprocessing": {
    "target_size": [1024, 1024],
    "resize_mode": "aspect_ratio_preserving",
    "padding_color": [0, 0, 0],
    "normalization": {
      "mean": [128.0, 128.0, 128.0],
      "std": [256.0, 256.0, 256.0],
      "range": [0.0, 255.0]
    },
    "color_space": "RGB",
    "interpolation": "Triangle"
  },
  "postprocessing": {
    "output_format": "grayscale_mask",
    "threshold": null,
    "smooth_edges": false,
    "mask_dilation": 0,
    "mask_blur": 0
  },
  "performance": {
    "recommended_batch_size": 1,
    "memory_usage_mb": 2048,
    "typical_inference_ms": 150
  },
  "supported_providers": ["CPU", "CUDA", "CoreML"],
  "tags": ["segmentation", "portrait", "general"]
}
```

## Cargo Feature Design

### Model Selection Features
```toml
[features]
default = ["isnet-fp16"]

# Model type selection (mutually exclusive)
isnet-fp16 = ["model-isnet", "precision-fp16"]
isnet-fp32 = ["model-isnet", "precision-fp32"]
u2net-fp16 = ["model-u2net", "precision-fp16"]
u2net-fp32 = ["model-u2net", "precision-fp32"]
rembg-fp16 = ["model-rembg", "precision-fp16"]
rembg-fp32 = ["model-rembg", "precision-fp32"]

# Internal features (not user-facing)
model-isnet = []
model-u2net = []
model-rembg = []
precision-fp16 = []
precision-fp32 = []
```

## Implementation Phases

### Phase 1: Model Configuration System (ðŸ”¥ Core Infrastructure)

**1.1 Create Model Configuration Types**
- `ModelConfig` struct matching model.json schema (compile-time constants)
- `PreprocessingConfig` and `PostprocessingConfig` as const structs
- Build-time model.json parsing via build script

**1.2 Compile-Time Model Selection**
```rust
// Generated by build script from model.json files
pub struct ModelConfig {
    pub name: &'static str,
    pub preprocessing: PreprocessingConfig,
    pub postprocessing: PostprocessingConfig,
    pub input_shape: [usize; 4],
    pub output_shape: [usize; 4],
}

pub const EMBEDDED_MODEL_CONFIG: ModelConfig = ModelConfig {
    // Populated by build script based on active features
};
```

**1.3 Update ModelManager for Compile-Time Config**
```rust
impl ModelManager {
    pub fn with_embedded() -> Self {
        Self {
            config: &EMBEDDED_MODEL_CONFIG,
            provider: Box::new(EmbeddedModelProvider),
        }
    }
    
    pub fn get_config(&self) -> &ModelConfig {
        self.config
    }
}
```

### Phase 2: Directory Restructure (ðŸ—‚ï¸ File Organization)

**2.1 Move ISNet Models**
- Create `models/isnet/` directory
- Move `isnet_fp16.onnx` and `isnet_fp32.onnx` to `models/isnet/`
- Create initial `models/isnet/model.json` with current ISNet configuration

**2.2 Add Build Script**
- Create `build.rs` to parse model.json files at compile time
- Generate `model_config.rs` with const structs based on active features
- Validate feature combinations (ensure only one model selected)

**2.3 Update Cargo Features**
```toml
# Replace current features
[features]
default = ["isnet-fp16"]
isnet-fp16 = ["model-isnet", "precision-fp16"]
isnet-fp32 = ["model-isnet", "precision-fp32"]
# ... other model features
```

### Phase 3: Configurable Processing Pipeline (âš™ï¸ Core Logic)

**3.1 Replace Hardcoded Values with Compile-Time Constants**
```rust
impl ImageProcessor {
    fn preprocess_image(&self, image: &DynamicImage) -> Result<(DynamicImage, Array4<f32>)> {
        let config = &EMBEDDED_MODEL_CONFIG.preprocessing;
        let target_size = config.target_size[0] as u32; // From model.json
        let mean = config.normalization.mean;           // From model.json  
        let std = config.normalization.std;             // From model.json
        // ... use config values instead of hardcoded
    }
}
```

**3.2 Compile-Time Preprocessing Configuration**
- Target size from model.json (compile-time const)
- Normalization parameters from model.json (compile-time const)
- Resize mode and interpolation from model.json
- Padding color from model.json

**3.3 Compile-Time Postprocessing Configuration** 
- Output tensor format handling from model.json
- Threshold and edge smoothing from model.json
- Mask processing parameters from model.json

### Phase 4: Compile-Time Model Information (ðŸ“‹ Introspection)

**4.1 Model Info Constants**
```rust
// Generated by build script
pub const EMBEDDED_MODEL_NAME: &str = "ISNet"; // or "U2Net", etc.
pub const EMBEDDED_MODEL_PRECISION: &str = "fp16"; // or "fp32"
pub const EMBEDDED_MODEL_SIZE_BYTES: usize = 88080384;

impl ImageProcessor {
    pub const fn model_name() -> &'static str {
        EMBEDDED_MODEL_NAME
    }
    
    pub const fn model_precision() -> &'static str {
        EMBEDDED_MODEL_PRECISION
    }
}
```

**4.2 Build-Time Model Validation**
- Validate model.json schema at build time
- Ensure model files exist for selected features
- Generate compile errors for invalid configurations

**4.3 No Runtime Model Selection**
- Remove any runtime model switching APIs
- Model is determined entirely by Cargo features
- Binary contains exactly one model configuration

### Phase 5: Testing and Examples (ðŸ§ª Validation)

**5.1 Multi-Model Tests**
- Unit tests for model.json parsing
- Integration tests with different model configurations
- Performance benchmarks across models

**5.2 Example Models**
- Create example U2Net configuration
- Create example RembG configuration  
- Document model addition process

**5.3 Migration Testing**
- Ensure existing ISNet functionality unchanged
- Test backward compatibility with existing API
- Validate feature flag behavior

## Implementation Order & Dependencies

```
Phase 1 (Build System) â†’ Phase 2 (Directory) â†’ Phase 3 (Processing) â†’ Phase 4 (Validation) â†’ Phase 5 (Testing)
     â†“                        â†“                      â†“                    â†“
[2-3 days]              [1 day]               [3-4 days]         [1-2 days]      [2-3 days]
```

## Breaking Changes & Migration

### Non-Breaking Changes
- New Cargo features (isnet-fp16/isnet-fp32 work exactly like current fp16-model/fp32-model)
- Same public API (ImageProcessor methods unchanged)
- Same functionality for ISNet model

### Potential Breaking Changes
- Cargo feature names: `fp16-model` â†’ `isnet-fp16`, `fp32-model` â†’ `isnet-fp32`
- include_bytes! paths change (internal only)
- Build script dependency added

### Migration Path for Users
```bash
# Old way
cargo build --features fp16-model

# New way  
cargo build --features isnet-fp16
```

### Migration Path for Development
1. **Phase 1-2**: Add build system, move files, maintain backward compatibility
2. **Phase 3**: Replace hardcoded values with generated constants
3. **Phase 4**: Add compile-time validation and new model support
4. **Phase 5**: Update documentation and add examples

## Benefits

### For Users
- **Multiple model support**: Choose optimal model per use case via Cargo features
- **Zero runtime overhead**: All configuration resolved at compile time
- **Performance optimization**: Select precision based on requirements
- **Easy model addition**: Drop in new models with JSON config and feature flag

### For Developers  
- **Maintainable code**: Model-specific logic externalized to config files
- **Zero-cost abstraction**: No runtime overhead for model configuration
- **Extensible design**: Easy to add new models via feature flags
- **Better documentation**: Model capabilities clearly specified in JSON
- **Compile-time safety**: Invalid configurations caught at build time

## Risks & Mitigations

### Technical Risks
- **Build complexity**: Build script dependencies and generated code
  - *Mitigation*: Comprehensive build script testing, clear error messages
- **Feature flag complexity**: Users select wrong combinations
  - *Mitigation*: Feature validation in build script, clear documentation

### Integration Risks
- **Backward compatibility**: Existing feature flags break
  - *Mitigation*: Gradual migration path, temporary feature aliases
- **Configuration complexity**: Model.json schema evolution
  - *Mitigation*: Schema versioning, validation, backward compatibility

## Success Criteria

### Technical Metrics
- [ ] All existing ISNet tests pass unchanged
- [ ] Build time increase < 20% (due to build script)
- [ ] Zero runtime overhead compared to current system
- [ ] Support for 3+ different model architectures

### API Quality Metrics  
- [ ] Zero breaking changes to existing public API
- [ ] Compile-time feature validation works correctly
- [ ] Model.json schema validates successfully at build time
- [ ] Feature flag migration path is clear

### Documentation Metrics
- [ ] Complete API documentation with feature examples
- [ ] Model addition guide for developers
- [ ] Migration guide for feature flag changes
- [ ] Build script documentation and troubleshooting